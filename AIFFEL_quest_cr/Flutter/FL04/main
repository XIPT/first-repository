import 'package:flutter/material.dart';
import 'App1.dart';
import 'App2.dart'; // BossTimerApp ì„í¬íŠ¸
import 'Signup.dart';
import 'package:url_launcher/url_launcher.dart';  // url_launcher ì„í¬íŠ¸
import 'package:flutter_web_plugins/flutter_web_plugins.dart'; // ì›¹ ì„¤ì • íŒ¨í‚¤ì§€ ì„í¬íŠ¸
import 'package:go_router/go_router.dart';  // GoRouter íŒ¨í‚¤ì§€ ì„í¬íŠ¸


void main() {
  setUrlStrategy(PathUrlStrategy()); // ì›¹ì—ì„œ #ì„ ì—†ì• ëŠ” ì„¤ì •

  runApp(MyApp());
}


class InputApp extends StatefulWidget {
  @override
  State<StatefulWidget> createState() => _InputAppState();
}

class _InputAppState extends State<InputApp> {
  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      routerDelegate: MyRouterDelegate(),
      routeInformationParser: MyRouteInformationParser(),
    );
  }
}

// ğŸ“Œ ê²½ë¡œ ì •ì˜
class MyRoutePath {
  final String? id;

  MyRoutePath.input() : id = null;
  MyRoutePath.home(this.id);
  MyRoutePath.error() : id = null;
}


// ğŸ“Œ Route Parser
class MyRouteInformationParser extends RouteInformationParser<MyRoutePath> {
  // ìœ íš¨í•œ ì•„ì´ë”” ë¦¬ìŠ¤íŠ¸

  @override
  Future<MyRoutePath> parseRouteInformation(RouteInformation routeInformation) async {
    final uri = Uri.parse(routeInformation.location ?? '/');

    // ì•„ì´ë””ê°€ ì—†ëŠ” ê²½ìš°, ì•„ì´ë”” ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì´ë™
    if (uri.pathSegments.isEmpty) {
      return MyRoutePath.input();
    }

    // ì•„ì´ë””ê°€ ìœ íš¨í•œì§€ ì²´í¬(ì´ìƒí•˜ê²Œ ì—†ì–´ë„ ì˜ëŒì•„ê°..)
    if (uri.pathSegments.length >= 1) {
      return MyRoutePath.home('');  // ìœ íš¨í•œ ì•„ì´ë””ë¡œ í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™
    }

    // ìœ íš¨í•˜ì§€ ì•Šì€ ì•„ì´ë””ëŠ” Error í™”ë©´ìœ¼ë¡œ ì´ë™
    return MyRoutePath.error();
  }

  @override
  RouteInformation restoreRouteInformation(MyRoutePath configuration) {
    if (configuration.id == null)
      return RouteInformation(location: '/input');
    else
      return RouteInformation(location: '/${configuration.id}');
  }
}


// ğŸ“Œ Router Delegate
class MyRouterDelegate extends RouterDelegate<MyRoutePath>
    with ChangeNotifier, PopNavigatorRouterDelegateMixin<MyRoutePath> {
  String? selectId;
  final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();
  final List<String> validIds = ['Park@hanmail.net', 'User123'];


  @override
  MyRoutePath get currentConfiguration {
    if (selectId != null) {
      return MyRoutePath.home(selectId);
    } else {
      return MyRoutePath.error();
    }
  }

  @override
  Widget build(BuildContext context) {
    return Navigator(
      key: navigatorKey,
      pages: [
        if (selectId == null) MaterialPage(child: InputScreen(_onIdEntered)),
        if (validIds.contains(selectId)) MaterialPage(child: HomeScreen()),
        if (selectId != null && !validIds.contains(selectId)) MaterialPage(child: ErrorScreen()),  // ìˆ˜ì •ëœ ë¶€ë¶„
      ],
      onPopPage: (route, result) {
        if (!route.didPop(result)) return false;

        selectId = null;
        notifyListeners();
        return true;
      },
    );
  }

  @override
  Future<void> setNewRoutePath(MyRoutePath configuration) async {
    if (configuration.id != null) {
      selectId = configuration.id;
    }
  }

  void _onIdEntered(String id) {
    selectId = id;
    notifyListeners();
  }

  void _onItemSelected(String id) {
    selectId = id;
    notifyListeners();
  }
}

// ğŸ“Œ ì•„ì´ë”” ì…ë ¥ í™”ë©´
class InputScreen extends StatelessWidget {
  final Function(String) onIdEntered;

  InputScreen(this.onIdEntered);

  final TextEditingController _controller = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        toolbarHeight: 150,
        // AppBarì˜ ë†’ì´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        flexibleSpace: Container(
          decoration: BoxDecoration(
            image: DecorationImage(
              image: AssetImage('assets/images/boss_timer_background.jpg'),
              fit: BoxFit.cover, // ì´ë¯¸ì§€ê°€ AppBarë¥¼ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì •
            ),
          ),
        ),
        title: Text(
          "ë¦°ì €ì”¨ì˜ ì„¸ê³„ë¡œ ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!",
          style: TextStyle(
            fontSize: 24,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        centerTitle: true,
        actions: [
          TextButton(
            onPressed: () {
              context.go('/signup'); //signup í™”ë©´ìœ¼ë¡œ ì´ë™
            },
            child: Text(
              "íšŒì›ê°€ì…",
              style: TextStyle(color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold),
            ),
          ),
        ],
      ),
      body: Center(
        child: Padding(
          padding: const EdgeInsets.all(16.0), // í™”ë©´ ì—¬ë°± ì¶”ê°€
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            crossAxisAlignment: CrossAxisAlignment.center,
            children: [
              // ì•„ì´ë”” ì…ë ¥ í•„ë“œ
              TextField(
                controller: _controller,
                decoration: InputDecoration(
                  labelText: 'ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                  labelStyle: TextStyle(color: Colors.blueAccent, fontSize: 18),
                  // ë¼ë²¨ ìƒ‰ìƒ ë° í¬ê¸°
                  hintText: 'ì´ë©”ì¼ ì•„ì´ë”” ì…ë‹ˆë‹¤.',
                  // íŒíŠ¸ í…ìŠ¤íŠ¸
                  hintStyle: TextStyle(color: Colors.grey[500], fontSize: 16),
                  // íŒíŠ¸ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼
                  filled: true,
                  fillColor: Colors.grey[200],
                  // ë°°ê²½ìƒ‰
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12), // ë‘¥ê·¼ ëª¨ì„œë¦¬
                    borderSide: BorderSide(color: Colors.blueAccent, width: 2),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(color: Colors.blueAccent, width: 2),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(12),
                    borderSide: BorderSide(
                        color: Colors.blueAccent.withOpacity(0.5), width: 2),
                  ),
                ),
                style: TextStyle(fontSize: 18), // í…ìŠ¤íŠ¸ í¬ê¸°
              ),
              SizedBox(height: 20), // ê°„ê²©

              // í™•ì¸ ë²„íŠ¼
              ElevatedButton(
                onPressed: () => onIdEntered(_controller.text),
                child: Text(
                  'í™•ì¸',
                  style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),
                ),
                style: ElevatedButton.styleFrom(
                  backgroundColor: Colors.blueAccent,
                  // ë²„íŠ¼ ë°°ê²½ìƒ‰
                  foregroundColor: Colors.white,
                  // ë²„íŠ¼ í…ìŠ¤íŠ¸ ìƒ‰
                  padding: EdgeInsets.symmetric(horizontal: 30, vertical: 12),
                  // ë²„íŠ¼ íŒ¨ë”©
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12), // ë²„íŠ¼ ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ
                  ),
                  shadowColor: Colors.blueAccent.withOpacity(0.4),
                  // ê·¸ë¦¼ì íš¨ê³¼
                  elevation: 6, // ê·¸ë¦¼ì ê¹Šì´
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}


// ğŸ“Œ ì—ëŸ¬ í™”ë©´
class ErrorScreen extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        toolbarHeight: 150,
        // AppBarì˜ ë†’ì´ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
        flexibleSpace: Container(
          decoration: BoxDecoration(
            image: DecorationImage(
              image: AssetImage('assets/images/boss_timer_background.jpg'),
              fit: BoxFit.cover, // ì´ë¯¸ì§€ê°€ AppBarë¥¼ ê°€ë“ ì±„ìš°ë„ë¡ ì„¤ì •
            ),
          ),
        ),
        title: Text(
          "ë¦°ì €ì”¨ì˜ ì„¸ê³„ë¡œ ì˜¤ì‹ ê±¸ í™˜ì˜í•©ë‹ˆë‹¤!",
          style: TextStyle(
            fontSize: 24,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        centerTitle: true,
        actions: [
          TextButton(
            onPressed: () {
              context.go('/signup'); //signup í™”ë©´ìœ¼ë¡œ ì´ë™
            },
            child: Text(
              "íšŒì›ê°€ì…",
              style: TextStyle(color: Colors.white,
                  fontSize: 18,
                  fontWeight: FontWeight.bold),
            ),
          ),
        ],
      ),
      body: Center(
        child: Text(
          'ìš°ì¸¡ìƒë‹¨ì— íšŒì›ê°€ì…í›„ ê²°ì œë¥¼ í•´ì•¼ ì‚¬ìš©í• ìˆ˜ ìˆìŠµë‹ˆë‹¤',
          style: TextStyle(fontSize: 24, color: Colors.red),
        ),
      ),
    );
  }
}


class MyApp extends StatelessWidget {
  final GoRouter _router = GoRouter(
    initialLocation: '/input', // ì•± ì‹œì‘ ì‹œ '/input' í˜ì´ì§€ë¡œ ì´ë™
    routes: [
      GoRoute(path: '/', builder: (context, state) => HomeScreen()),
      GoRoute(path: '/input', builder: (context, state) => InputApp()),
      GoRoute(path: '/one', builder: (context, state) => App1()),
      GoRoute(path: '/two', builder: (context, state) => BossTimerApp()),
      GoRoute(path: '/signup', builder: (context, state) => Join())
    ],
  );

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      debugShowCheckedModeBanner: false,
      routerConfig: _router,  // GoRouter ì„¤ì •
    );
  }
}

class HomeScreen extends StatefulWidget {
  @override
  _HomeScreenState createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> {
  List<String> mainSelection1 = ['ê³ ì •ë³´ìŠ¤ì‹œê°„'];
  List<String> mainSelection2 = ['ë³´íƒìŠ¤ì¼€ì¤„ëŸ¬'];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        toolbarHeight: 150,
        flexibleSpace: Container(
          decoration: BoxDecoration(
            image: DecorationImage(
              image: AssetImage('assets/images/boss_timer_background.jpg'),
              fit: BoxFit.cover,
            ),
          ),
        ),
        title: Text(
          "ë¦¬ë‹ˆì§€M ë³´ìŠ¤ì²´í¬",
          style: TextStyle(
            fontSize: 24,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        centerTitle: true,
      ),
      body: Column(
        children: [
          Expanded(
            child: Row(
              children: [
                // ì²« ë²ˆì§¸ ë¦¬ìŠ¤íŠ¸ (mainSelection1)
                Expanded(
                  child: GridView.builder(
                    shrinkWrap: true,
                    padding: EdgeInsets.all(10),
                    itemCount: mainSelection1.length,
                    scrollDirection: Axis.vertical,
                    gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                      crossAxisCount: 1,
                      childAspectRatio: 1,
                    ),
                    itemBuilder: (context, index) {
                      return InkWell(
                        onTap: () {
                          debugPrint("ê³ ì •ë³´ìŠ¤ì‹œê°„ ë²„íŠ¼ í´ë¦­ë¨!");
                          context.go('/one'); // GoRouter ì‚¬ìš©
                        },
                        child: Card(
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Text(mainSelection1[index], style: TextStyle(fontSize: 18)),
                              SizedBox(height: 10),
                              Expanded(
                                child: Container(
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(10),
                                    image: DecorationImage(
                                      image: AssetImage('assets/images/Monster/í”¼ë‹‰ìŠ¤.jpg'),
                                      fit: BoxFit.cover,
                                      colorFilter: ColorFilter.mode(
                                        Colors.black.withOpacity(0.7),
                                        BlendMode.dstATop,
                                      ),
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ),
                // ë‘ ë²ˆì§¸ ë¦¬ìŠ¤íŠ¸ (mainSelection2)
                Expanded(
                  child: GridView.builder(
                    shrinkWrap: true,
                    padding: EdgeInsets.all(10),
                    itemCount: mainSelection2.length,
                    scrollDirection: Axis.vertical,
                    gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(
                      crossAxisCount: 1,
                      childAspectRatio: 1,
                    ),
                    itemBuilder: (context, index) {
                      return InkWell(
                        onTap: () {
                          debugPrint("ë³´íƒìŠ¤ì¼€ì¤„ëŸ¬ ë²„íŠ¼ í´ë¦­ë¨!");
                          context.go('/two'); // GoRouter ì‚¬ìš©
                        },
                        child: Card(
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(10),
                          ),
                          child: Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Text(mainSelection2[index], style: TextStyle(fontSize: 18)),
                              SizedBox(height: 10),
                              Expanded(
                                child: Container(
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(10),
                                    image: DecorationImage(
                                      image: AssetImage('assets/images/Monster/ê±°ëŒ€ë“œë ˆì´í¬.jpg'),
                                      fit: BoxFit.cover,
                                      colorFilter: ColorFilter.mode(
                                        Colors.black.withOpacity(0.7),
                                        BlendMode.dstATop,
                                      ),
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      );
                    },
                  ),
                ),
              ],
            ),
          ),
          SizedBox(height: 20),
        ],
      ),
      bottomNavigationBar: BottomNavigationBar(
        currentIndex: _selectedIndex,
        onTap: _onItemTapped,
        items: const <BottomNavigationBarItem>[
          BottomNavigationBarItem(
            icon: Icon(Icons.home),
            label: 'ì—…ë°ì´íŠ¸',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.search),
            label: 'ì•„ì´í…œì‹œì„¸',
          ),
          BottomNavigationBarItem(
            icon: Icon(Icons.account_circle),
            label: 'ì»¤ë®¤ë‹ˆí‹°',
          ),
        ],
      ),
    );
  }

  int _selectedIndex = 0;

  void _onItemTapped(int index) {
    setState(() {
      _selectedIndex = index;
    });

    if (index == 0) {
      _launchURL('https://lineagem.plaync.com/board/cm_story/list');
    } else if (index == 1) {
      _launchURL('https://lineagem.plaync.com/price/itemprice/index/?serverid=all');
    } else if (index == 2) {
      _launchURL('https://lineagem.plaync.com/board/all/list');
    }
  }

  void _launchURL(String url) async {
    if (await canLaunch(url)) {
      await launch(url);
    } else {
      throw 'Could not launch $url';
    }
  }
}
