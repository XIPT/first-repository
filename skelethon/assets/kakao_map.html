<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Kakao Map Sample</title>
    <style>
        html, body {margin:0; padding:0; height:100%;}
        #map {width:100%; height:100%;}
        .hospital-label {
            display: block;
            padding: 8px 10px;
            background: #fff;
            border-radius: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap;
            min-width: 120px;
        }
        .hospital-distance {
            display: block;
            margin-top: 4px;
            color: #666;
            font-size: 11px;
            font-weight: normal;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=KAKAO_MAP_API_KEY"></script>
<script>
    var mapContainer = document.getElementById('map');
    var mapOption = {
      center: new kakao.maps.LatLng(37.5665, 126.9780),  // Í∏∞Î≥∏ ÏúÑÏπò
      level: 4
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // üìç ÎÇ¥ ÏúÑÏπò ÎßàÏª§ Î≥ÄÏàò
    var userMarker = null;

    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎßàÏª§ÏôÄ Ïù∏Îç±Ïä§
    var selectedMarkerIndex = -1;
    var selectedMarker = null;

    // ÏÑ†ÌÉùÎêú ÎßàÏª§Ïùò Ï†ïÎ≥¥Ï∞ΩÏùÑ Ï†ÄÏû•Ìï† Ï†ÑÏó≠ Î≥ÄÏàò
    var currentOverlay = null;

    // Îπ®Í∞ÑÏÉâ ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ ÏÉùÏÑ± (ÎÇ¥ ÏúÑÏπòÏö©)
    var redMarkerImage = new kakao.maps.MarkerImage(
        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', // Îπ®Í∞Ñ Î≥Ñ ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ URL
        new kakao.maps.Size(24, 35), // ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞
        {
            offset: new kakao.maps.Point(12, 35), // ÎßàÏª§ Ï¢åÌëúÏóê ÏùºÏπòÏãúÌÇ¨ Ïù¥ÎØ∏ÏßÄ Ï¢åÌëú
            alt: "ÌòÑÏû¨ ÏúÑÏπò"
        }
    );

    // ÏùºÎ∞ò Î≥ëÏõê ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ
    var normalMarkerImage = new kakao.maps.MarkerImage(
        'https://t1.daumcdn.net/mapjsapi/images/marker.png',
        new kakao.maps.Size(29, 42),
        {
            offset: new kakao.maps.Point(14, 42),
            alt: "Î≥ëÏõê"
        }
    );

    // ÏÑ†ÌÉùÎêú Î≥ëÏõê ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ (Îçî ÌÅ∞ ÌÅ¨Í∏∞)
    var selectedMarkerImage = new kakao.maps.MarkerImage(
        'https://t1.daumcdn.net/mapjsapi/images/marker.png',
        new kakao.maps.Size(50, 72), // ÌÅ¨Í∏∞Î•º Ìõ®Ïî¨ Îçî ÌÅ¨Í≤å ÏÑ§Ï†ï
        {
            offset: new kakao.maps.Point(25, 72), // Ïò§ÌîÑÏÖãÎèÑ ÎπÑÎ°ÄÌï¥ÏÑú Ï°∞Ï†ï
            alt: "ÏÑ†ÌÉùÎêú Î≥ëÏõê"
        }
    );

    // ÏÇ¨Ïö©Ïûê ÏúÑÏπò ÎßàÏª§ ÏÉùÏÑ± Ìï®Ïàò
    function showUserLocation(lat, lng) {
        // Í∏∞Ï°¥ ÎßàÏª§Í∞Ä ÏûàÎã§Î©¥ ÏÇ≠Ï†ú
        if (userMarker !== null) {
            userMarker.setMap(null);
        }

        // üìç ÎÇ¥ ÏúÑÏπò ÎßàÏª§ ÏÉùÏÑ± (Îπ®Í∞ÑÏÉâ ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
        userMarker = new kakao.maps.Marker({
            map: map,
            position: new kakao.maps.LatLng(lat, lng),
            title: 'ÌòÑÏû¨ ÏúÑÏπò',
            image: redMarkerImage, // Îπ®Í∞ÑÏÉâ ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ Ï†ÅÏö©
            zIndex: 9999
        });

        console.log("ÏÇ¨Ïö©Ïûê ÏúÑÏπò ÎßàÏª§ ÏÉùÏÑ± (Îπ®Í∞ÑÏÉâ):", lat, lng);
    }

    // FlutterÏóêÏÑú Ìò∏Ï∂úÌïòÎäî ÏúÑÏπò Ïù¥Îèô Ìï®Ïàò
    function moveToLocation(lat, lng) {
        console.log("FlutterÏóêÏÑú ÏúÑÏπò Ïù¥Îèô Ìò∏Ï∂úÎê®:", lat, lng);
        var moveLatLon = new kakao.maps.LatLng(lat, lng);
        map.setCenter(moveLatLon);

        // ÏúÑÏπò Ïù¥Îèô Ïãú ÏûêÎèôÏúºÎ°ú Ìï¥Îãπ ÏúÑÏπòÏóê ÎßàÏª§ÎèÑ ÌëúÏãú
        showUserLocation(lat, lng);
    }

    // ÏÑ†ÌÉùÎêú ÎßàÏª§Ïùò Ï†ïÎ≥¥ ÌëúÏãúÏ∞Ω ÎùÑÏö∞Í∏∞ (Ïª§Ïä§ÌÖÄ Ïò§Î≤ÑÎ†àÏù¥ ÏÇ¨Ïö©)
    function showMarkerInfo(index) {
        console.log("showMarkerInfo Ìò∏Ï∂úÎê®: Ïù∏Îç±Ïä§=" + index);

        if (index >= 0 && index < originalData.length) {
            // Ïù¥Ï†ÑÏóê Ïó¥Î†§ÏûàÎäî Ï†ïÎ≥¥Ï∞ΩÏù¥ ÏûàÏúºÎ©¥ Îã´Í∏∞
            if (currentOverlay !== null) {
                currentOverlay.setMap(null);
                console.log("Ïù¥Ï†Ñ Ïò§Î≤ÑÎ†àÏù¥ Îã´Ìûò");
            }

            var hospital = originalData[index];
            var marker = markers[index];
            var position = marker.getPosition();

            // Í±∞Î¶¨ Ï†ïÎ≥¥ Ìè¨Îß∑ÌåÖ
            var distanceText = '';
            if (hospital.distance) {
                var distanceKm = (parseFloat(hospital.distance) / 1000).toFixed(1);
                distanceText = '<span class="hospital-distance">' + distanceKm + 'km</span>';
            }

            // Ïª§Ïä§ÌÖÄ Ïò§Î≤ÑÎ†àÏù¥ ÏÉùÏÑ±
            var content = '<div class="hospital-label">' +
                          hospital.name +
                          distanceText +
                          '</div>';

            var customOverlay = new kakao.maps.CustomOverlay({
                position: position,
                content: content,
                yAnchor: 0.1,  // ÎßàÏª§ ÏúÑÏóê ÌëúÏãú
                zIndex: 10000
            });

            // Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãú
            customOverlay.setMap(map);
            console.log("Ïª§Ïä§ÌÖÄ Ïò§Î≤ÑÎ†àÏù¥ ÌëúÏãúÎê®");

            // ÌòÑÏû¨ Ïò§Î≤ÑÎ†àÏù¥ Ï†ÄÏû•
            currentOverlay = customOverlay;
        } else {
            console.log("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù∏Îç±Ïä§ (showMarkerInfo): " + index);
        }
    }

    // ÏõπÎ∑∞Î°ú ÏÑ†ÌÉùÎêú Î≥ëÏõêÏùò Ïù∏Îç±Ïä§ Ï†ÑÎã¨
    function selectHospital(index) {
        console.log("selectHospital Ìò∏Ï∂úÎê®: Ïù∏Îç±Ïä§=" + index);

        if (index >= 0 && index < originalData.length) {
            // Ïù¥Ï†ÑÏóê ÏÑ†ÌÉùÎêú ÎßàÏª§Í∞Ä ÏûàÏúºÎ©¥ ÏõêÎûò ÌÅ¨Í∏∞Î°ú Î≥µÏõê
            if (selectedMarker !== null) {
                console.log("Ïù¥Ï†Ñ ÏÑ†ÌÉù ÎßàÏª§ Ï¥àÍ∏∞Ìôî");
                selectedMarker.setImage(normalMarkerImage);
            }

            // ÏÉàÎ°úÏö¥ ÎßàÏª§ ÏÑ†ÌÉù
            var marker = markers[index];
            console.log("ÏÉà ÎßàÏª§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω ÏãúÎèÑ");
            marker.setImage(selectedMarkerImage);
            selectedMarker = marker;
            selectedMarkerIndex = index;
            console.log("ÏÉà ÎßàÏª§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω ÏôÑÎ£å");
        }
    }

    // Î≥ëÏõê Ïù∏Îç±Ïä§Î°ú Ìï¥Îãπ ÎßàÏª§ Ï§ëÏïôÏúºÎ°ú Ïù¥ÎèôÌïòÍ≥† ÏÑ†ÌÉù ÌëúÏãú
    function moveToHospital(index) {
        console.log("moveToHospital Ìò∏Ï∂úÎê®: Ïù∏Îç±Ïä§=" + index);

        if (index >= 0 && index < originalData.length) {
            var hospital = originalData[index];
            var moveLatLon = new kakao.maps.LatLng(hospital.lat, hospital.lng);
            map.setCenter(moveLatLon);
            console.log("ÏßÄÎèÑ Ï§ëÏã¨ Ïù¥Îèô ÏôÑÎ£å");

            // ÎßàÏª§ ÏÑ†ÌÉù ÌëúÏãú
            selectHospital(index);
            console.log("ÎßàÏª§ ÏÑ†ÌÉù ÏôÑÎ£å");

            // ÎßàÏª§ Ï†ïÎ≥¥Ï∞Ω ÌëúÏãú (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ Ï∂îÍ∞Ä)
            setTimeout(function() {
                showMarkerInfo(index);
            }, 100);

            // Îßµ ÏúÑÏπò Ïù¥Îèô ÌõÑ FlutterÏóê ÏïåÎ¶º
            try {
                window.onMarkerClicked.postMessage(index.toString());
                console.log("moveToHospitalÏóêÏÑú FlutterÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏÑ±Í≥µ");
            } catch (e) {
                console.log("moveToHospitalÏóêÏÑú FlutterÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: " + e.message);
            }
        } else {
            console.log("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù∏Îç±Ïä§: " + index);
        }
    }

    // üè• Î≥ëÏõê ÎßàÏª§ Í¥ÄÎ¶¨
    var markers = [];
    var originalData = []; // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•

    function clearMarkers() {
        markers.forEach(function(marker) {
            marker.setMap(null);
        });
        markers = [];
        originalData = [];

        // ÏÑ†ÌÉù ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        selectedMarkerIndex = -1;
        selectedMarker = null;

        // Ïó¥Î†§ÏûàÎäî Ïò§Î≤ÑÎ†àÏù¥ Îã´Í∏∞
        if (currentOverlay !== null) {
            currentOverlay.setMap(null);
            currentOverlay = null;
        }
    }

    function addHospitalMarkers(hospitals) {
        clearMarkers();   // Í∏∞Ï°¥ ÎßàÏª§ ÏÇ≠Ï†ú

        var hospitalList = JSON.parse(hospitals);
        originalData = hospitalList; // ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•

        hospitalList.forEach(function(hospital, index) {
            var marker = new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(hospital.lat, hospital.lng),
                title: hospital.name,
                image: normalMarkerImage // Í∏∞Î≥∏ ÎßàÏª§ Ïù¥ÎØ∏ÏßÄ Ï†ÅÏö©
            });

            markers.push(marker);

            // ÎßàÏª§ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Ïóê Î°úÍ∑∏ Ï∂îÍ∞Ä
            kakao.maps.event.addListener(marker, 'click', function() {
                console.log("ÎßàÏª§ ÌÅ¥Î¶≠Îê®: Ïù∏Îç±Ïä§=" + index);

                if (selectedMarker !== null) {
                    console.log("Ïù¥Ï†Ñ ÏÑ†ÌÉù ÎßàÏª§ Ï¥àÍ∏∞Ìôî");
                    selectedMarker.setImage(normalMarkerImage);
                }

                console.log("ÎßàÏª§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω ÏãúÎèÑ");
                marker.setImage(selectedMarkerImage);
                selectedMarker = marker;
                selectedMarkerIndex = index;
                console.log("ÎßàÏª§ ÌÅ¨Í∏∞ Î≥ÄÍ≤Ω ÏôÑÎ£å");

                // ÎßàÏª§ ÌÅ¥Î¶≠ Ïãú ÏûêÎèôÏúºÎ°ú Ï†ïÎ≥¥Ï∞Ω ÌëúÏãú
                showMarkerInfo(index);

                // ÏõπÎ∑∞ Î∏åÎ¶øÏßÄÎ•º ÌÜµÌï¥ FlutterÏóê Î©îÏãúÏßÄ Ï†ÑÎã¨
                try {
                    window.onMarkerClicked.postMessage(index.toString());
                    console.log("FlutterÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏÑ±Í≥µ");
                } catch (e) {
                    console.log("FlutterÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®: " + e.message);
                }
            });
        });
    }

    // Î≥∏Ïù∏ÏúÑÏπò GPS Îã§Ïãú Ïû°ÏïÑÏ£ºÎäî Ìï®Ïàò
    function moveToCurrentLocation() {
    console.log("ÌòÑÏû¨ ÏúÑÏπòÎ°ú Ïù¥Îèô Ìï®Ïàò Ìò∏Ï∂úÎê®");

    // ÏõπÎ∑∞Í∞Ä Ï¥àÍ∏∞ÌôîÎê† Îïå ÏÑ§Ï†ïÌïú ÏÇ¨Ïö©Ïûê ÏúÑÏπòÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏ ÏúÑÏπòÎ°ú Ïù¥Îèô
    if (userMarker !== null) {
        var position = userMarker.getPosition();
        map.setCenter(position);
        console.log("ÏÇ¨Ïö©Ïûê ÏúÑÏπòÎ°ú ÏßÄÎèÑ Ï§ëÏã¨ Ïù¥Îèô");

        // Ï§å Î†àÎ≤® Ï°∞Ï†ï (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
        map.setLevel(4);
    } else {
        console.log("ÏÇ¨Ïö©Ïûê ÏúÑÏπò ÎßàÏª§Í∞Ä ÏóÜÏäµÎãàÎã§. moveToLocationÏùÑ Î®ºÏ†Ä Ìò∏Ï∂úÌï¥Ï£ºÏÑ∏Ïöî.");
    }
}
</script>
</body>
</html>